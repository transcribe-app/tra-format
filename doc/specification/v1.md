# TRA Format Specification v1.0

The TRA format is designed for storing text transcriptions together with an audio file, featuring precise word and sentence markup linked to the audio.
The format is an extension of the MIME standard (RFC 822, RFC 2045+, etc.).

## Features

-   **Synchronization:** Combines text transcription with precise timings and the corresponding audio file. Supports both **word-level** and **character-level** timestamps.
-   **MIME Structure:** A TRA file is a Multi-part MIME message. This allows the extraction of transcription and audio without specialized tools (using any utility that understands the MIME format).
-   **Streaming Support:** A TRA file can be transmitted via real-time streaming. Parts of the MIME message can be split into small chunks with minimal overhead.

## TRA File Structure

-   **Main Components:** TRA-specific MIME headers, Transcription JSON, and Transcription Audio.
-   **Attachments:** Transcription JSON and Transcription Audio are standard file attachments based on the Multi-part MIME specification.
-   **Message Body:** The text body of the MIME message contains a description or summary, or the first few lines of the text representation of the transcription.
-   **Multi-file Support:** A TRA file may contain multiple Transcription JSON or Audio parts; grouping should be performed based on the file attachment name.
-   **Extensibility:** A TRA file may contain headers and parts not described in this specification; such elements must be ignored/skipped during parsing.

### TRA File Example

```http
MIME-Version: 1.0
Transcription-Tra-Version: 1.0
Transcription-Filename: hello-world
Transcription-Duration: 2
Transcription-Lang: en-US
Transcription-Created: 1764582815
Content-Type: multipart/mixed;boundary="tra-mime-1764582815"

Summary: Hello, World!

--tra-mime-1764582815
Content-Disposition: attachment;filename="audio.json"
Content-Type: application/json

[{"doc":"json_v2"},
{"ph":1,"sp":"1","ts":0.0,"te":2.001},{"wr":"Hello,","ts":0.0,"te":1.0},{"wr":"World","ts":1.0,"te":2.001}]

--tra-mime-1764582815
Content-Disposition: attachment;filename="audio.mp3"
Content-Type: audio/mpeg
Content-Length: ...

ID3...
--tra-mime-1764582815--
```

# TRA-Specific MIME Headers

-   **Transcription-Tra-Version:** `string`. The version of the format.
-   **Transcription-Filename:** `string`. The name of the transcription.
-   **Transcription-Duration:** `int`. Duration in seconds.
-   **Transcription-Lang:** `string`. BCP-47 language code of the audio file. For multilingual audio, multiple languages can be specified, separated by commas.
-   **Transcription-Created:** `int`. Unix timestamp of the moment the transcription was created.

# Transcription JSON

-   **Structure:** The Transcription JSON is an **array of objects**. The first element is the **document description**, followed by alternating **paragraph descriptions** and **paragraph words**.
-   **Sequence:** `[{document description}, {paragraph description}, {word}, {word}..., {paragraph description}, {word}...]`. The JSON is processed sequentially. A `ph` object sets the current paragraph context (ID, speaker, timestamps). All subsequent `wr` objects belong to the most recently declared `ph` until a new `ph` object is encountered.
-   **Document Description Keys:**
    -   `"doc"` (document): `string`. JSON format version. Default value is `"json_v2"`.
    -   `"tm"` (timestamps mode): `string`. Timestamp type.
        -   Value `"word"`: Word-level timestamps. Words do not contain surrounding spaces; spaces should be added automatically for presentation.
        -   Value `"char"`: Character-level timestamps. Words contain all necessary whitespace; they are merged as-is without extra processing.
-   **Paragraph Description Keys:**
    -   `"ph"` (paragraph): `int`. Monotonically increasing paragraph ID.
    -   `"sp"` (speaker): optional `int` or `string`. Identifier of the speaker for words in this paragraph.
    -   `"he"` (header): optional `string`. Paragraph header/title.
    -   `"ts"` / `"te"` (timestamp start/end): optional `float`. Timestamps in seconds indicating the interval in the corresponding audio.
-   **Word Keys:**
    -   `"wr"` (word): `string`. A part of the transcription text. Presentation depends on the `"tm"` key in the document description.
    -   `"ts"` / `"te"` (timestamp start/end): optional `float`. Timestamps in seconds indicating the interval in the corresponding audio.

# Transcription Audio

Preferred audio formats are **OGG** and **MP3**.

# Streaming Specifics

-   A TRA File can be split into chunks to support streaming scenarios. Each block is tagged with the time interval it covers.
-   The Multi-part `Content-Disposition` header must be augmented with `ts` (start) and `te` (end) parameters corresponding to the current part.
-   **Transcription Audio** must be recorded in a format that supports splitting into blocks (concatenation-friendly).
-   **Transcription JSON** represents an array of elements falling within the block's interval. The complete Transcription JSON is obtained by simply concatenating the content of arrays of the blocks in sequential order.
-   **Updates:** Transcription JSON in different blocks may contain paragraphs with the same `"ph"` number. In this case, the later version replaces/updates the earlier one.

### TRA File Example (Streaming)

```http
MIME-Version: 1.0
Transcription-Tra-Version: 1.0
Transcription-Filename: hello-world
Transcription-Duration: 6
Transcription-Lang: en-US
Transcription-Created: 1764582815
Content-Type: multipart/mixed;boundary="tra-mime-1764582815"

Summary: Hello, World!

--tra-mime-1764582815
Content-Disposition: attachment;filename="audio.json";ts="0.0";te="2.0"
Content-Type: application/json

[{"doc":"json_v2"},
{"ph":1,"cf":1,"sp":"1","ts":0.0,"te":2.0},{"wr":"Hello,","ts":0.0,"te":1.0},{"wr":"World","ts":1.0,"te":2.0}]

--tra-mime-1764582815
Content-Disposition: attachment;filename="audio.mp3";ts="0.0";te="2.0"
Content-Type: audio/mpeg
Content-Length: ...

ID3...

--tra-mime-1764582815
Content-Disposition: attachment;filename="audio.json";ts="2.0";te="4.0"
Content-Type: application/json

[{"ph":2,"cf":1,"sp":"1","ts":2.0,"te":4.0},{"wr":"Hello,","ts":2.0,"te":3.0},{"wr":"World","ts":3.0,"te":4.0}]

--tra-mime-1764582815
Content-Disposition: attachment;filename="audio.mp3";ts="2.0";te="4.0"
Content-Type: audio/mpeg
Content-Length: ...

ID3...

--tra-mime-1764582815
Content-Disposition: attachment;filename="audio.json";ts="4.0";te="6.0"
Content-Type: application/json

[{"ph":3,"cf":1,"sp":"1","ts":4.0,"te":6.0},{"wr":"Hello,","ts":4.0,"te":5.0},{"wr":"World","ts":5.0,"te":6.0}]

--tra-mime-1764582815
Content-Disposition: attachment;filename="audio.mp3";ts="4.0";te="6.0"
Content-Type: audio/mpeg
Content-Length: ...

ID3...
--tra-mime-1764582815--
```

# Design Choices / Rationale

-   **MIME as Core Format:** The MIME structure allows for both archival combination of multiple files into one (audio, transcription, or multiple transcriptions) and arbitrary splitting by convenient criteria (e.g., text+audio for interval 0-2, 2-4, etc.) for streaming.
-   **Short JSON Keys:** Use of two-letter key combinations to reduce the JSON file size.